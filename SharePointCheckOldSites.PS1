Clear-Host
#
#
#            _________.__                        __________      .__        __ ________   ________.________       __________              
#           /   _____/|  |__ _____ _______   ____\______   \____ |__| _____/  |\_____  \ /  _____/|   ____/       \______   \____ ______  
#           \_____  \ |  |  \\__  \\_  __ \_/ __ \|     ___/  _ \|  |/    \   __\_(__  </   __  \ |____  \         |     ___/    \\____ \ 
#           /        \|   Y  \/ __ \|  | \/\  ___/|    |  (  <_> )  |   |  \  | /       \  |__\  \/       \        |    |  |   |  \  |_> >
#          /_______  /|___|  (____  /__|    \___  >____|   \____/|__|___|  /__|/______  /\_____  /______  /        |____|  |___|  /   __/ 
#                  \/      \/     \/            \/                       \/           \/       \/       \/                      \/|__|    
# 
#
#
#                  - R√©alis√© par KERLOC'H Jean-Philip @ HashTag -
#                            - PRECISION @ 2025 -


# ---------------------------------------------#
# A faire uniquement √† la premiere execution   #
# ---------------------------------------------#
# Register-PnPEntraIDApp -ApplicationName "PnP-Microsoft365" -Tenant "precisionglobalmigration.onmicrosoft.com"
# Set-ExecutionPolicy Bypass -Scope CurrentUser -Force

# ------------------------------------------------#
# V√©rification de l'√©tat du repository PSGallery  #
# ------------------------------------------------#

$repository = Get-PSRepository -Name 'PSGallery' -ErrorAction SilentlyContinue

if ($repository -and $repository.InstallationPolicy -eq 'Trusted') {
    Write-Host "Le repository 'PSGallery' est d√©j√† d√©fini comme Trusted." -ForegroundColor Green
    Start-Sleep -Seconds 2
} else {
    Write-Host "Le repository 'PSGallery' n'est pas Trusted. Mise √† jour en cours..." -ForegroundColor Yellow
    Start-Sleep -Seconds 2
    try {
        Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
        Write-Host "Le repository 'PSGallery' a √©t√© d√©fini en mode Trusted avec succ√®s." -ForegroundColor Green
        Start-Sleep -Seconds 2
    } catch {
        Write-Host "Erreur lors de la mise √† jour du repository 'PSGallery'. V√©rifiez vos permissions." -ForegroundColor Red
        Start-Sleep -Seconds 2
        exit
    }
}


# ------------------------------------------------#
# V√©rification et installation de PnP.PowerShell  #
# ------------------------------------------------#

# V√©rification si le module est install√©
$moduleName = "PnP.PowerShell"
if (Get-Module -ListAvailable -Name $moduleName) {
    Write-Host "Le module '$moduleName' est d√©j√† install√©." -ForegroundColor Green
    Start-Sleep -Seconds 2
} else {
    Write-Host "Le module '$moduleName' n'est pas install√©. Installation en cours..." -ForegroundColor Yellow
    Start-Sleep -Seconds 2
    try {
        Install-Module -Name $moduleName -Force -Confirm:$false
        Write-Host "Le module '$moduleName' a √©t√© install√© avec succ√®s." -ForegroundColor Green
        Start-Sleep -Seconds 2
    } catch {
        Write-Host "Erreur lors de l'installation du module '$moduleName'. V√©rifiez vos permissions." -ForegroundColor Red
        Start-Sleep -Seconds 2
        exit
    }
}


# ---------------------------------------#
# V√©rification de la version PowerShell  #
# ---------------------------------------#

# R√©cup√©rer la version actuelle de PowerShell
$psVersion = $PSVersionTable.PSVersion.Major

if ($psVersion -lt 7) {
    Write-Host "PowerShell 7 est requis. Installation en cours..." -ForegroundColor Yellow
    # V√©rifier si winget est install√©
    if (Get-Command winget -ErrorAction SilentlyContinue) {
        # Installer PowerShell 7 avec winget
        winget install --id Microsoft.PowerShell --source winget --accept-source-agreements --accept-package-agreements
        Write-Host "Installation termin√©e. Veuillez red√©marrer votre terminal et ex√©cuter √† nouveau le script." -ForegroundColor Green
        Start-Sleep -Seconds 2
    } else {
        Write-Host "Winget n'est pas install√© sur ce syst√®me. Veuillez l'installer manuellement depuis le site Microsoft." -ForegroundColor Red
        Start-Sleep -Seconds 2
    }
    exit
}

Write-Host "PowerShell 7 d√©tect√©. Poursuite de l'ex√©cution du script..." -ForegroundColor Green

# ----------------------------#
# Connexion √† SharePoint      #
# ----------------------------#

# R√©cup√©ration dynamique du r√©pertoire utilisateur
$userProfile = $env:USERPROFILE

# D√©finition du chemin du certificat en fonction de l'utilisateur connect√©
$secureCertificatePass = "$userProfile\OneDrive - Precision Global\Documents\PnP-SharePoint\PnP-Microsoft365.pfx"

# V√©rification si le fichier de certificat existe
if (-Not (Test-Path $secureCertificatePass)) {
    Write-Host "Le fichier de certificat n'existe pas : $secureCertificatePass" -ForegroundColor Red
    Start-Sleep -Seconds 2
    exit
}
Write-Host "Chemin du certificat utilis√© : $secureCertificatePass" -ForegroundColor Green
Start-Sleep -Seconds 2

# Chemin du certificat PFX
$siteUrl = "https://precisionglobalmigration-admin.sharepoint.com"
$clientId = "5ebb53ec-b0a0-45cf-b9d2-a8f9db1d62fd"
$tenant = "precisionglobalmigration.onmicrosoft.com"
$Thumbprint ="5C26D932379DBBE4E459A57926C8147A6CE1AACD"

try {
    #Connect-PnPOnline -Tenant $tenant -Url $siteUrl -ClientId $clientId -Thumbprint $Thumbprint
    Connect-PnPOnline -Url $siteUrl -ClientId $clientId -CertificatePath $secureCertificatePass -Tenant $tenant
    Write-Host "Connexion √† SharePoint r√©ussie." -ForegroundColor Green
    Start-Sleep -Seconds 2
} catch {
    Write-Host "√âchec de la connexion √† SharePoint. V√©rifiez les informations d'identification." -ForegroundColor Red
    Start-Sleep -Seconds 2
    exit
}




####################### Check Old Sites On Sharepoint ############################
# Connexion interactive
Connect-PnPOnline -Url $siteUrl -ClientId $clientId -CertificatePath $secureCertificatePass -Tenant $tenant

# Seuil d'inactivit√© : 12 mois
$threshold = (Get-Date).AddMonths(-12)

# R√©cup√©ration de tous les sites (SharePoint uniquement, pas OneDrive)
$sites = Get-PnPTenantSite | Where-Object { $_.Url -notmatch "-my.sharepoint.com" }

Write-Host "`nüîé Sites inactifs depuis plus de 12 mois ou sans activit√© connue :" -ForegroundColor Cyan

# Compteur
$counter = 0

# Analyse et affichage
foreach ($site in $sites) {
    $lastMod = $site.LastContentModifiedDate

    if ($null -eq $lastMod -or $lastMod -lt $threshold) {
        $counter++
        $affDate = if ($lastMod) { $lastMod.ToString("yyyy-MM-dd") } else { "N/A" }

        Write-Host "[$counter] $($site.Url)" -ForegroundColor Yellow
        Write-Host "     ‚û§ Title      : $($site.Title)"
        Write-Host "     ‚û§ Template   : $($site.Template)"
        Write-Host "     ‚û§ Last Modif : $affDate"
        Write-Host ""
    }
}

if ($counter -eq 0) {
    Write-Host "`n‚úÖ Aucun site inactif trouv√© selon les crit√®res." -ForegroundColor Green
}

##########################################################################